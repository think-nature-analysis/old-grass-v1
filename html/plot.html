<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Mesh3 Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #chart-container { display: flex; flex-direction: column; gap: 20px; }
    #barChart {
      width: 350px !important;
      height: 180px !important;
    }
    #radarChart {
      width: 350px !important;
      height: 350px !important;
    }
  </style>
</head>
<body>
  <div id="chart-container">
    <canvas id="barChart"></canvas>
    <canvas id="radarChart"></canvas>
  </div>

  <script>
    // ===== TSV ローダー =====
    async function loadTSV(path) {
      const text = await fetch(path).then(r => r.text());
      const rows = text.trim().split("\n").map(r => r.split("\t"));
      const header = rows[0].map(h => h.trim());
      const data = rows.slice(1).map(r => {
        const obj = {};
        header.forEach((h, i) => { obj[h] = r[i]; });
        return obj;
      });
      return { header, data };
    }

    // ===== URL パラメータ取得 =====
    function getParams() {
      const url = new URL(window.location.href);
      return { arg: url.searchParams.get("arg"), p: url.searchParams.get("p") };
    }

    // ===== p=1: 棒グラフ + レーダーチャート =====
    function showChartP1(row, header) {
      // --- 棒グラフ ---
      const barCols = [
        "保全優先度全国ランク_全分類群",
        "保全優先度県内ランク_全分類群"
      ];
      const barLabels = ["全国ランク_全分類群", "県内ランク_全分類群"];
      const barValues = barCols.map(c => parseFloat(row[c]));
      const barColors = ["rgba(220,50,50,0.8)", "rgba(255,165,0,0.8)"];

      new Chart(document.getElementById("barChart").getContext("2d"), {
        type: "bar",
        data: {
          labels: barLabels,
          datasets: [{
            label: "保全優先度",
            data: barValues,
            backgroundColor: barColors
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          indexAxis: "y",
          scales: {
            x: { min: 0, max: 1, title: { display: true, text: "値" } },
            y: { title: { display: false } }
          }
        }
      });

      // --- レーダーチャート ---
      const radarCols = header.filter(h =>
        h.startsWith("保全優先度全国ランク_") && !h.endsWith("_全分類群")
      );
      const radarLabels = radarCols.map(c => c.replace("保全優先度全国ランク_", ""));
      const radarValues = radarCols.map(c => parseFloat(row[c]));

      new Chart(document.getElementById("radarChart").getContext("2d"), {
        type: "radar",
        data: {
          labels: radarLabels,
          datasets: [{
            label: "保全優先度",
            data: radarValues,
            backgroundColor: "rgba(54, 162, 235, 0.2)",
            borderColor: "rgba(54, 162, 235, 1)",
            pointBackgroundColor: "rgba(54, 162, 235, 1)"
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { font: { size: 16 } } } },
          scales: {
            r: {
              suggestedMin: 0,
              suggestedMax: 1,
              ticks: { stepSize: 0.2, font: { size: 12 } },
              pointLabels: { font: { size: 16 } }
            }
          }
        }
      });
    }

    // ===== p=2: 種数ランク レーダーチャート =====
    function showChartP2(row, header) {
      document.getElementById("barChart").style.display = "none"; // 棒グラフは非表示

      const rankCols = header.filter(h => h.startsWith("種数ランク_"));
      const baseCols = rankCols.map(c => "種数_" + c.replace("種数ランク_", ""));
      const labels = baseCols.map(c => {
        const suffix = c.replace("種数_", "");
        const count = Math.round(parseFloat(row[c]));
        return suffix + "\n" + count + "種";
      });
      const values = rankCols.map(c => parseFloat(row[c]));


      new Chart(document.getElementById("radarChart").getContext("2d"), {
        type: "radar",
        data: {
          labels: labels,
          datasets: [{
            label: "種数（周囲1km）",
            data: values,
            backgroundColor: "rgba(54, 162, 235, 0.2)",
            borderColor: "rgba(54, 162, 235, 1)",
            pointBackgroundColor: "rgba(54, 162, 235, 1)"
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { font: { size: 16 } } } },
          scales: {
            r: {
              suggestedMin: 0,
              suggestedMax: 1,
              backdropColor: "transparent",
              ticks: { stepSize: 0.2, font: { size: 12 } },
              pointLabels: {
                font: { size: 16 },
                callback: function(label) {
                  return label.split("\n");
                }
              }
            }
          }
        }
      });
    }

    // ===== メイン処理 =====
    (async () => {
      const { header, data } = await loadTSV("biodiv_info.tsv");
      const params = getParams();
      const row = data.find(r => r["mesh3"] === params.arg);

      if (!row) {
        document.body.innerHTML += "<p>該当する mesh3 が見つかりません</p>";
        return;
      }

      if (params.p === "1") {
        showChartP1(row, header);
      } else if (params.p === "2") {
        showChartP2(row, header);
      }
    })();
  </script>
</body>
</html>
